
> [!NOTE]
> Documentation auto-generated by [ai-docs.](https://github.com/connor-john/ai-docs)

I'll create comprehensive documentation for this Python module, which appears to be a testing utility for structured logging.

# pytest-structlog Documentation

## Module Overview

This module provides a testing utility for structured logging in Python using `pytest` and `structlog`. It offers a `StructuredLogCapture` fixture that enables testing of log messages and their associated context in a structured way.

### Key Features
- Log event capture and verification
- Context-aware log message testing
- Support for multiple log levels
- Flexible log event comparison
- Event factory methods for test setup

### Dependencies
- pytest
- structlog
- logging (standard library)

## Installation and Setup

```bash
pip install pytest-structlog
```

### Required Dependencies
```
pytest>=6.0.0
structlog>=20.0.0
```

### Configuration
Add to your pytest configuration (pytest.ini or conftest.py):
```ini
[pytest]
pytester_example_dir = tests
```

## Usage Guide

### Basic Usage

1. Capturing Log Events
```python
def test_basic_logging(log: StructuredLogCapture):
    logger = structlog.get_logger()
    logger.info("test message")
    assert log.has("test message")
```

2. Testing with Context
```python
def test_contextual_logging(log: StructuredLogCapture):
    logger = structlog.get_logger()
    logger.info("process started", process_id=123)
    assert log.has("process started", process_id=123, level="info")
```

### Advanced Features

1. Event Factory Methods
```python
def test_log_factory(log: StructuredLogCapture):
    # Create test event expectations
    debug_event = log.debug("debug message", extra="data")
    info_event = log.info("info message", context="value")

    assert debug_event == {
        "event": "debug message",
        "level": "debug",
        "extra": "data"
    }
```

2. Log Event Comparison
```python
def test_log_comparison(log: StructuredLogCapture):
    logger = structlog.get_logger()
    logger.info("event1")
    logger.info("event2")

    expected_events = [
        {"event": "event1", "level": "info"},
        {"event": "event2", "level": "info"}
    ]
    assert log.events == expected_events
```

## Testing Guide

### Basic Test Cases

```python
def test_simple_log_capture(log: StructuredLogCapture):
    """Test basic log capture functionality."""
    logger = structlog.get_logger()
    logger.info("test")
    assert log.has("test")
```

### Context Testing

```python
def test_log_context(log: StructuredLogCapture):
    """Test logging with context data."""
    logger = structlog.get_logger()
    logger.info("message", user_id=123, action="login")
    assert log.has("message", user_id=123, action="login", level="info")
```

### Testing Log Levels

```python
@pytest.mark.parametrize("level,name", [
    (logging.DEBUG, "debug"),
    (logging.INFO, "info"),
    (logging.WARNING, "warning"),
    (logging.ERROR, "error"),
    (logging.CRITICAL, "critical"),
])
def test_log_levels(log: StructuredLogCapture, level, name):
    """Test different log levels."""
    logger = structlog.get_logger()
    logger.log(level, "test message")
    assert log.has("test message", level=name)
```

### Testing Bound Loggers

```python
def test_bound_logger(log: StructuredLogCapture):
    """Test bound logger functionality."""
    logger = structlog.get_logger()
    bound_logger = logger.bind(component="auth")
    bound_logger.info("login attempt")
    assert log.has("login attempt", component="auth", level="info")
```

### Testing Multiple Events

```python
def test_multiple_events(log: StructuredLogCapture):
    """Test capturing multiple log events."""
    logger = structlog.get_logger()
    logger.info("first")
    logger.warning("second")

    assert len(log.events) == 2
    assert log.events == [
        {"event": "first", "level": "info"},
        {"event": "second", "level": "warning"}
    ]
```

## Best Practices

1. Always use type hints with the fixture:
```python
def test_example(log: StructuredLogCapture) -> None:
    ...
```

2. Test both success and failure cases:
```python
def test_log_assertions(log: StructuredLogCapture):
    logger = structlog.get_logger()
    logger.info("message", value=42)

    assert log.has("message", value=42)  # Should pass
    assert not log.has("message", value=43)  # Should pass
```

3. Use descriptive test names and docstrings:
```python
def test_log_context_verification(log: StructuredLogCapture):
    """
    Verify that log context is correctly captured and can be
    accurately compared with expected values.
    """
    ...
```

4. Clean up after tests:
```python
@pytest.fixture(autouse=True)
def cleanup_logs():
    yield
    structlog.reset_defaults()
```

## Error Handling and Edge Cases

```python
def test_invalid_log_level(log: StructuredLogCapture):
    """Test handling of invalid log levels."""
    logger = structlog.get_logger()
    logger.log(9999, "invalid level")
    assert log.has("invalid level", level="level 9999")
```

## Performance Considerations

- The log capture fixture has minimal overhead
- Consider clearing logs for long-running tests
- Use appropriate log levels to minimize unnecessary capturing

## Debugging Tips

1. Print captured events:
```python
def test_debug_logs(log: StructuredLogCapture):
    logger = structlog.get_logger()
    logger.info("debug me")
    print(log.events)  # For debugging
```

2. Use pytest's verbose mode:
```bash
pytest -v test_file.py
```

3. Enable log capture in pytest:
```bash
pytest --log-cli-level=DEBUG
```

This documentation covers the main features and usage patterns of the module. The test examples demonstrate common scenarios and best practices for using the StructuredLogCapture fixture in your tests.
