
> [!NOTE]
> Documentation auto-generated by [ai-docs.](https://github.com/connor-john/ai-docs)

I'll create comprehensive documentation for this pytest-structlog module, including testing examples.

# pytest-structlog Module Documentation

## Module Overview

pytest-structlog is a pytest plugin that provides structured logging capture and testing capabilities. It allows developers to:
- Capture and inspect structured log events during tests
- Assert on log messages and their contexts
- Configure which log processors to keep or evict during testing
- Control log processor behavior through pytest configuration

Key features:
- Log event capture and inspection
- Flexible processor configuration
- Custom log event assertions
- Automatic test failure logging
- Rich configuration options

Dependencies:
- pytest
- structlog
- Python 3.7+

## Installation and Setup

```bash
pip install pytest-structlog
```

### Configuration

Configure through pytest.ini or command line arguments:

```ini
# pytest.ini
[pytest]
structlog_keep =
    add_log_level
    ExceptionRenderer
structlog_evict =
    TimeStamper
    JSONRenderer
structlog_explicit = false
structlog_settings_report = auto
```

Or via command line:

```bash
pytest --structlog-keep=add_log_level --structlog-evict=TimeStamper
```

## Usage Guide

### Basic Usage

```python
def test_basic_logging(log):
    logger = structlog.get_logger()
    logger.info("test message", extra="value")

    assert log.has("test message", extra="value")
```

### Advanced Usage

```python
def test_complex_logging(log):
    logger = structlog.get_logger()

    # Log multiple events
    logger.debug("debug message", context="test")
    logger.info("info message", user_id=123)
    logger.error("error message", error_code=500)

    # Assert using log level helpers
    assert log.debug("debug message", context="test") in log.events
    assert log.info("info message", user_id=123) in log.events
    assert log.error("error message", error_code=500) in log.events
```

## Testing Guide

### Test Cases

1. Basic Log Capture Test

```python
from typing import Generator
import pytest
import structlog

def test_log_capture(log: StructuredLogCapture) -> None:
    """Test basic log capture functionality."""
    logger = structlog.get_logger()
    logger.info("test message", key="value")

    assert log.has("test message")
    assert log.has("test message", key="value")
    assert len(log.events) == 1
```

2. Log Level Test

```python
@pytest.mark.parametrize("level,method", [
    (logging.DEBUG, "debug"),
    (logging.INFO, "info"),
    (logging.WARNING, "warning"),
    (logging.ERROR, "error"),
    (logging.CRITICAL, "critical"),
])
def test_log_levels(
    log: StructuredLogCapture,
    level: int,
    method: str
) -> None:
    """Test logging at different levels."""
    logger = structlog.get_logger()
    getattr(logger, method)("test message")

    expected = log.log(level, "test message")
    assert expected in log.events
```

3. Event List Subsequence Test

```python
def test_event_list_subsequence(log: StructuredLogCapture) -> None:
    """Test EventList subsequence comparison functionality."""
    events = EventList([
        {"event": "first"},
        {"event": "second"},
        {"event": "third"}
    ])

    subset = EventList([
        {"event": "first"},
        {"event": "third"}
    ])

    assert subset <= events  # Subsequence check
    assert not (events <= subset)  # Not a subsequence
```

4. Processor Configuration Test

```python
def test_processor_configuration(monkeypatch: MonkeyPatch) -> None:
    """Test processor configuration settings."""
    settings.mode = "keep"
    settings.keep["cmdline-arg"].add("add_log_level")

    keep, reason = settings.use_processor("add_log_level")
    assert keep
    assert reason == "cmdline-arg"
```

### Test Fixtures

```python
@pytest.fixture
def custom_logger(log: StructuredLogCapture) -> Generator[structlog.BoundLogger, None, None]:
    """Fixture providing a configured logger instance."""
    logger = structlog.get_logger()
    yield logger

@pytest.fixture
def sample_events() -> Generator[EventList, None, None]:
    """Fixture providing sample log events."""
    events = EventList([
        {"event": "test1", "level": "info"},
        {"event": "test2", "level": "error"}
    ])
    yield events
```

### Integration Testing

```python
def test_integration_with_app(
    log: StructuredLogCapture,
    app: Flask,
    client: FlaskClient
) -> None:
    """Test logging integration with Flask application."""
    response = client.get("/api/endpoint")

    assert response.status_code == 200
    assert log.has(
        "request processed",
        path="/api/endpoint",
        method="GET"
    )
```

### Performance Testing

```python
def test_log_capture_performance(log: StructuredLogCapture, benchmark) -> None:
    """Test log capture performance."""
    logger = structlog.get_logger()

    def log_messages() -> None:
        for _ in range(100):
            logger.info("test message", iteration=i)

    benchmark(log_messages)
```

## Error Handling and Edge Cases

```python
def test_invalid_log_level(log: StructuredLogCapture) -> None:
    """Test handling of invalid log levels."""
    with pytest.raises(ValueError):
        log.log("INVALID_LEVEL", "test message")

def test_empty_event_list(log: StructuredLogCapture) -> None:
    """Test behavior with empty event list."""
    assert len(log.events) == 0
    assert not log.has("any message")
```

## Debugging Tips

1. Increase verbosity for detailed processor configuration:
```bash
pytest -vv
```

2. Use the settings report:
```python
def test_with_debug(log: StructuredLogCapture, capfd) -> None:
    settings.report = "always"
    # Test code
    captured = capfd.readouterr()
    assert "pytest-structlog settings" in captured.out
```

3. Inspect captured events:
```python
def test_with_inspection(log: StructuredLogCapture) -> None:
    logger = structlog.get_logger()
    logger.info("debug me")

    import pdb; pdb.set_trace()
    # Now you can inspect log.events interactively
```

This documentation provides a comprehensive overview of the pytest-structlog module and its testing capabilities. The examples demonstrate both basic and advanced usage patterns, along with proper testing practices and error handling approaches.
