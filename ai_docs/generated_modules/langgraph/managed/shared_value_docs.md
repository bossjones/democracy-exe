
> [!NOTE]
> Documentation auto-generated by [ai-docs.](https://github.com/connor-john/ai-docs)

I'll create comprehensive documentation and testing examples for the SharedValue module.

# SharedValue Module Documentation

## Module Overview
The `SharedValue` module implements a managed value system for sharing dictionary data across different scopes in an application. It provides both synchronous and asynchronous interfaces for managing shared state.

Key Features:
- Scope-based value sharing
- Persistent storage support
- Type-safe dictionary updates
- Synchronous and asynchronous APIs

Dependencies:
- Python 3.7+
- typing_extensions
- langgraph framework

## Installation and Setup
```bash
pip install langgraph
```

## Usage Guide

### Basic Usage
```python
from langgraph import SharedValue

# Create a shared value with a specific scope
shared = SharedValue.on("my_scope")

# Using the shared value in a context
with shared.enter(loop) as value:
    # Get current value
    current = value()

    # Update value
    value.update([{"key": {"nested": "data"}}])
```

### Async Usage
```python
async with shared.aenter(loop) as value:
    current = value()
    await value.aupdate([{"key": {"nested": "data"}}])
```

## Testing Guide

### Basic Test Setup

```python
# test_shared_value.py
from __future__ import annotations

import pytest
from typing import AsyncGenerator, Generator
from pytest_mock import MockerFixture

from langgraph import SharedValue, LoopProtocol

@pytest.fixture
def mock_loop(mocker: MockerFixture) -> Generator[LoopProtocol, None, None]:
    """Create a mock loop for testing.

    Returns:
        Generator[LoopProtocol, None, None]: Mock loop instance
    """
    loop = mocker.Mock(spec=LoopProtocol)
    loop.store = None
    loop.config = {"conf": {"test_scope": "test_value"}}
    yield loop

@pytest.fixture
def shared_value(mock_loop: LoopProtocol) -> Generator[SharedValue, None, None]:
    """Create a SharedValue instance for testing.

    Args:
        mock_loop: Mock loop protocol

    Returns:
        Generator[SharedValue, None, None]: SharedValue instance
    """
    value = SharedValue(
        loop=mock_loop,
        typ=dict,
        scope="test_scope",
        key="test_key"
    )
    yield value
```

### Test Cases

```python
def test_shared_value_initialization(shared_value: SharedValue) -> None:
    """Test SharedValue initialization.

    Args:
        shared_value: SharedValue fixture
    """
    assert shared_value.value == {}
    assert shared_value.scope == "test_scope"

def test_shared_value_update(shared_value: SharedValue) -> None:
    """Test updating SharedValue.

    Args:
        shared_value: SharedValue fixture
    """
    update_data = [{"key1": {"value": "test"}}]
    shared_value.update(update_data)

    assert shared_value() == {"key1": {"value": "test"}}

def test_invalid_update(shared_value: SharedValue) -> None:
    """Test invalid update handling.

    Args:
        shared_value: SharedValue fixture
    """
    invalid_data = [{"key1": "not_a_dict"}]

    with pytest.raises(InvalidUpdateError):
        shared_value.update(invalid_data)

@pytest.mark.asyncio
async def test_async_update(shared_value: SharedValue) -> None:
    """Test async update functionality.

    Args:
        shared_value: SharedValue fixture
    """
    update_data = [{"key1": {"value": "test"}}]
    await shared_value.aupdate(update_data)

    assert shared_value() == {"key1": {"value": "test"}}

def test_value_deletion(shared_value: SharedValue) -> None:
    """Test deleting values from SharedValue.

    Args:
        shared_value: SharedValue fixture
    """
    # First add some data
    shared_value.update([{"key1": {"value": "test"}}])

    # Then delete it
    shared_value.update([{"key1": None}])

    assert "key1" not in shared_value()
```

### Testing with Storage

```python
@pytest.fixture
def mock_store(mocker: MockerFixture) -> Generator[Any, None, None]:
    """Create a mock store for testing.

    Returns:
        Generator[Any, None, None]: Mock store instance
    """
    store = mocker.Mock()
    store.search.return_value = []
    store.asearch.return_value = []
    yield store

@pytest.fixture
def shared_value_with_store(
    mock_loop: LoopProtocol,
    mock_store: Any
) -> Generator[SharedValue, None, None]:
    """Create SharedValue with storage enabled.

    Args:
        mock_loop: Mock loop protocol
        mock_store: Mock store instance

    Returns:
        Generator[SharedValue, None, None]: SharedValue instance with store
    """
    mock_loop.store = mock_store
    value = SharedValue(
        loop=mock_loop,
        typ=dict,
        scope="test_scope",
        key="test_key"
    )
    yield value

def test_store_integration(
    shared_value_with_store: SharedValue,
    mock_store: Any
) -> None:
    """Test integration with storage.

    Args:
        shared_value_with_store: SharedValue fixture with store
        mock_store: Mock store instance
    """
    update_data = [{"key1": {"value": "test"}}]
    shared_value_with_store.update(update_data)

    assert mock_store.batch.called
```

## Testing Best Practices

1. Always test both synchronous and asynchronous methods
2. Test error conditions and edge cases
3. Verify proper integration with storage backend
4. Test type validation
5. Ensure proper cleanup in fixtures
6. Use type hints consistently
7. Test scope configuration handling

## Error Handling Tests

```python
def test_invalid_type_initialization(mock_loop: LoopProtocol) -> None:
    """Test initialization with invalid type.

    Args:
        mock_loop: Mock loop protocol
    """
    with pytest.raises(ValueError):
        SharedValue(
            loop=mock_loop,
            typ=str,  # Invalid type
            scope="test_scope",
            key="test_key"
        )

def test_missing_scope_configuration(mock_loop: LoopProtocol) -> None:
    """Test initialization with missing scope.

    Args:
        mock_loop: Mock loop protocol
    """
    mock_loop.config = {"conf": {}}  # Empty config

    with pytest.raises(ValueError):
        SharedValue(
            loop=mock_loop,
            typ=dict,
            scope="missing_scope",
            key="test_key"
        )
```

## Performance Testing

```python
import time

def test_update_performance(shared_value: SharedValue) -> None:
    """Test update performance.

    Args:
        shared_value: SharedValue fixture
    """
    start_time = time.time()

    for i in range(1000):
        shared_value.update([{f"key_{i}": {"value": i}}])

    duration = time.time() - start_time
    assert duration < 1.0  # Should complete within 1 second
```

This documentation provides a comprehensive guide for using and testing the SharedValue module. The test examples cover the main functionality, error cases, and integration scenarios. Make sure to adapt the tests based on your specific requirements and add more test cases as needed.
