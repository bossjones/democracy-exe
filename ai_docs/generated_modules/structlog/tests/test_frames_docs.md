
> [!NOTE]
> Documentation auto-generated by [ai-docs.](https://github.com/connor-john/ai-docs)

I'll create comprehensive documentation for this module, which appears to be part of the structlog library and handles stack frame manipulation and exception formatting.

# Module Documentation: structlog._frames

## Module Overview
This module provides utilities for stack frame manipulation and exception formatting within the structlog library. It contains three main functions:
- `_find_first_app_frame_and_name`: Locates the first application frame in the call stack
- `_format_exception`: Formats exception information
- `_format_stack`: Formats stack traces

### Key Features
- Stack frame inspection and filtering
- Exception formatting
- Stack trace formatting
- Configurable frame ignoring

### Dependencies
- Python 3.7+
- `pretend` (for testing)
- `pytest` (for testing)

## Installation and Setup
This module is part of the structlog package and should not be installed separately.

```bash
pip install structlog
```

## Usage Guide

### Finding Application Frames
```python
from structlog._frames import _find_first_app_frame_and_name

# Get the first non-structlog frame and its module name
frame, name = _find_first_app_frame_and_name()

# With additional frames to ignore
frame, name = _find_first_app_frame_and_name(
    additional_ignores=["my_module"]
)
```

### Formatting Exceptions
```python
from structlog._frames import _format_exception
import sys

try:
    raise ValueError("Example error")
except ValueError:
    exc_info = sys.exc_info()
    formatted_exception = _format_exception(exc_info)
    print(formatted_exception)
```

### Formatting Stack Traces
```python
from structlog._frames import _format_stack
import sys

stack_trace = _format_stack(sys._getframe())
print(stack_trace)
```

## Testing Guide

### Test Structure
Here's a complete test suite demonstrating how to test each component:

```python
# test_frames.py
from __future__ import annotations

import sys
from typing import Any, Tuple

import pytest
from pretend import stub

from structlog._frames import (
    _find_first_app_frame_and_name,
    _format_exception,
    _format_stack,
)

class TestFindFirstAppFrameAndName:
    def test_basic_frame_finding(self) -> None:
        """Test basic frame finding functionality."""
        # Create test frames
        f1 = stub(f_globals={"__name__": "test_app"}, f_back=None)
        f2 = stub(f_globals={"__name__": "structlog.core"}, f_back=f1)

        frame, name = _find_first_app_frame_and_name(_getframe=lambda: f2)

        assert frame == f1
        assert name == "test_app"

    def test_with_additional_ignores(self) -> None:
        """Test frame finding with additional ignored modules."""
        f1 = stub(f_globals={"__name__": "test_app"}, f_back=None)
        f2 = stub(f_globals={"__name__": "ignore_me"}, f_back=f1)
        f3 = stub(f_globals={"__name__": "structlog.core"}, f_back=f2)

        frame, name = _find_first_app_frame_and_name(
            additional_ignores=["ignore_me"],
            _getframe=lambda: f3
        )

        assert frame == f1
        assert name == "test_app"

@pytest.fixture
def exception_info() -> Tuple[Any, Any, Any]:
    """Fixture providing exception info for testing."""
    try:
        raise ValueError("Test exception")
    except ValueError:
        return sys.exc_info()

class TestFormatException:
    def test_exception_formatting(
        self,
        exception_info: Tuple[Any, Any, Any]
    ) -> None:
        """Test exception formatting."""
        formatted = _format_exception(exception_info)

        assert isinstance(formatted, str)
        assert "Traceback" in formatted
        assert "ValueError" in formatted

class TestFormatStack:
    def test_stack_formatting(self) -> None:
        """Test stack trace formatting."""
        formatted = _format_stack(sys._getframe())

        assert isinstance(formatted, str)
        assert "Stack (most recent call last):" in formatted
```

### Test Fixtures

```python
@pytest.fixture
def mock_frame():
    """Fixture providing a mock frame for testing."""
    return stub(
        f_globals={"__name__": "test_module"},
        f_back=None
    )

@pytest.fixture
def nested_frames():
    """Fixture providing nested frames for testing."""
    f1 = stub(f_globals={"__name__": "app_code"}, f_back=None)
    f2 = stub(f_globals={"__name__": "middleware"}, f_back=f1)
    f3 = stub(f_globals={"__name__": "structlog"}, f_back=f2)
    return f1, f2, f3
```

### Testing Best Practices
1. Test frame navigation logic thoroughly
2. Include edge cases (None values, missing attributes)
3. Test exception formatting with various exception types
4. Verify string output formats
5. Test with different Python versions
6. Mock system calls where appropriate

## Error Handling and Edge Cases

```python
def test_edge_cases() -> None:
    """Test various edge cases in frame handling."""
    # Missing __name__
    f1 = stub(f_globals={}, f_back=None)
    frame, name = _find_first_app_frame_and_name(_getframe=lambda: f1)
    assert name == "?"

    # None as __name__
    f2 = stub(f_globals={"__name__": None}, f_back=None)
    frame, name = _find_first_app_frame_and_name(_getframe=lambda: f2)
    assert name == "?"

    # All frames ignored
    f3 = stub(f_globals={"__name__": "structlog"}, f_back=None)
    frame, name = _find_first_app_frame_and_name(_getframe=lambda: f3)
    assert name == "?"
```

## Integration Testing

```python
def test_real_stack_trace() -> None:
    """Integration test with real stack traces."""
    def nested_function():
        return _format_stack(sys._getframe())

    formatted = nested_function()
    assert "nested_function" in formatted
    assert "test_real_stack_trace" in formatted
```

## Debugging and Troubleshooting

### Common Issues
1. Frame navigation errors
   - Check if all frames have expected attributes
   - Verify frame chain integrity
2. Exception formatting issues
   - Ensure exception info tuple is complete
   - Check for Unicode handling

### Logging Setup
```python
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)
```

This documentation provides a comprehensive guide to understanding and testing the structlog._frames module. The test examples cover all major functionality and include proper error handling and edge cases.
