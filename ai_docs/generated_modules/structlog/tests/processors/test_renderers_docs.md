
> [!NOTE]
> Documentation auto-generated by [ai-docs.](https://github.com/connor-john/ai-docs)

Here's a comprehensive documentation for the Python module focused on structlog processors and renderers:

# Structlog Processors Module Documentation

## Module Overview

This module provides various processors and renderers for structlog, a structured logging library for Python. The key components include:

- Key-value rendering (KeyValueRenderer)
- Logfmt format rendering (LogfmtRenderer)
- JSON rendering (JSONRenderer)
- Timestamp processing (TimeStamper, MaybeTimeStamper)
- Exception formatting (ExceptionRenderer)

### Key Features
- Flexible rendering formats
- Customizable key ordering and sorting
- Timestamp handling in various formats
- Exception information formatting
- Support for both UTC and local timestamps
- JSON serialization with fallback handling

### Dependencies
- Python 3.6+
- structlog
- freezegun (for testing)
- simplejson (optional)

## Installation and Setup

```bash
pip install structlog
# For testing
pip install pytest freezegun
# Optional
pip install simplejson
```

## Usage Guide

### Key-Value Renderer

```python
from structlog.processors import KeyValueRenderer

# Basic usage
renderer = KeyValueRenderer()
# With sorting
renderer = KeyValueRenderer(sort_keys=True)
# With custom key order
renderer = KeyValueRenderer(key_order=["timestamp", "level", "event"])
```

### Logfmt Renderer

```python
from structlog.processors import LogfmtRenderer

# Basic usage
renderer = LogfmtRenderer()
# With boolean flags
renderer = LogfmtRenderer(bool_as_flag=True)
```

### JSON Renderer

```python
from structlog.processors import JSONRenderer

# Basic usage
renderer = JSONRenderer()
# With custom serializer
renderer = JSONRenderer(serializer=custom_serializer)
```

### TimeStamper

```python
from structlog.processors import TimeStamper

# UTC timestamp
stamper = TimeStamper()
# ISO format
stamper = TimeStamper(fmt="iso", utc=True)
# Custom format
stamper = TimeStamper(fmt="%Y-%m-%d %H:%M:%S")
```

## Testing Guide

### Test Examples

#### Testing KeyValueRenderer

```python
from structlog.processors import KeyValueRenderer
import pytest

class TestKeyValueRenderer:
    @pytest.fixture
    def event_dict(self):
        return {
            "x": 7,
            "y": "test",
            "z": (1, 2),
            "a": "<A(\\o/)>",
            "b": [3, 4],
        }

    def test_sort_keys(self, event_dict):
        """Test that keys are sorted when sort_keys=True"""
        renderer = KeyValueRenderer(sort_keys=True)
        result = renderer(None, None, event_dict)

        assert r"a=<A(\o/)> b=[3, 4] x=7 y='test' z=(1, 2)" == result

    def test_key_order(self, event_dict):
        """Test custom key ordering"""
        renderer = KeyValueRenderer(key_order=["y", "x"])
        result = renderer(None, None, event_dict)

        assert result.startswith("y='test' x=7")
```

#### Testing LogfmtRenderer

```python
import pytest
from structlog.processors import LogfmtRenderer

class TestLogfmtRenderer:
    @pytest.fixture
    def event_dict(self):
        return {
            "message": "test message",
            "level": "info",
            "success": True
        }

    def test_bool_rendering(self, event_dict):
        """Test boolean rendering options"""
        renderer = LogfmtRenderer(bool_as_flag=True)
        result = renderer(None, None, event_dict)

        assert "success" in result
        assert "success=true" not in result

    def test_escaped_values(self):
        """Test proper escaping of special characters"""
        renderer = LogfmtRenderer()
        result = renderer(None, None, {"key": "value with spaces"})

        assert 'key="value with spaces"' == result
```

#### Testing TimeStamper

```python
from freezegun import freeze_time
import pytest
from structlog.processors import TimeStamper

class TestTimeStamper:
    @freeze_time("2023-01-01 12:00:00")
    def test_iso_format(self):
        """Test ISO format timestamp generation"""
        stamper = TimeStamper(fmt="iso", utc=True)
        result = stamper(None, None, {})

        assert result["timestamp"] == "2023-01-01T12:00:00Z"

    @pytest.mark.parametrize("fmt", [
        "iso",
        "%Y-%m-%d",
        "%H:%M:%S"
    ])
    def test_format_options(self, fmt):
        """Test various timestamp formats"""
        stamper = TimeStamper(fmt=fmt)
        result = stamper(None, None, {})

        assert "timestamp" in result
```

### Testing Best Practices

1. Use Fixtures for Common Test Data
```python
@pytest.fixture
def event_dict():
    """Common event dictionary for testing"""
    return {
        "message": "test",
        "level": "info",
        "timestamp": "2023-01-01T12:00:00Z"
    }
```

2. Test Edge Cases
```python
def test_empty_event_dict():
    """Test handling of empty event dictionaries"""
    renderer = LogfmtRenderer()
    result = renderer(None, None, {})
    assert result == ""
```

3. Use Parametrized Tests
```python
@pytest.mark.parametrize("input,expected", [
    ({"a": True}, "a"),
    ({"a": False}, "a=false"),
    ({"a": "value"}, "a=value")
])
def test_various_inputs(input, expected):
    renderer = LogfmtRenderer(bool_as_flag=True)
    assert renderer(None, None, input) == expected
```

4. Test Exception Cases
```python
def test_invalid_timestamp_config():
    """Test that invalid configurations raise appropriate errors"""
    with pytest.raises(ValueError):
        TimeStamper(utc=False, fmt=None)  # UNIX timestamps require UTC
```

## Error Handling and Edge Cases

```python
def test_json_fallback():
    """Test JSON fallback handling for unsupported types"""
    renderer = JSONRenderer()

    class CustomObj:
        pass

    result = renderer(None, None, {"obj": CustomObj()})
    assert isinstance(result, str)
    assert "CustomObj" in result

def test_invalid_logfmt_keys():
    """Test handling of invalid logfmt keys"""
    renderer = LogfmtRenderer()
    with pytest.raises(ValueError):
        renderer(None, None, {"invalid key": "value"})
```

This documentation provides a solid foundation for understanding and testing the module. The test examples cover the main functionality while demonstrating best practices in Python testing.
